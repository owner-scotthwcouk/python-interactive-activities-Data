<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Python Automation Workshop</title>
    <!-- Favicon: Python Snake Emoji -->
    <link rel="icon" href="data:image/svg+xml,<svg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 100 100%22><text y=%22.9em%22 font-size=%2290%22>üêç</text></svg>">
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Fira+Code:wght@400;500&family=Inter:wght@400;600;700&display=swap" rel="stylesheet">
    <!-- Supabase Client -->
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <style>
        body { font-family: 'Inter', sans-serif; background-color: #0f172a; color: #e2e8f0; }
        .code-font { font-family: 'Fira Code', monospace; }
        
        /* Custom Scrollbar */
        ::-webkit-scrollbar { width: 8px; height: 8px; }
        ::-webkit-scrollbar-track { background: #1e293b; }
        ::-webkit-scrollbar-thumb { background: #475569; border-radius: 4px; }
        ::-webkit-scrollbar-thumb:hover { background: #64748b; }

        .crt-flicker { animation: flicker 0.15s infinite; }
        @keyframes flicker {
            0% { opacity: 0.98; }
            50% { opacity: 1; }
            100% { opacity: 0.98; }
        }

        .step-active { border-left: 4px solid #3b82f6; background-color: #1e293b; }
        .step-inactive { border-left: 4px solid transparent; opacity: 0.5; }
        .step-done { border-left: 4px solid #10b981; opacity: 0.7; }

        .excel-grid { display: grid; grid-template-columns: repeat(3, 1fr); gap: 1px; background-color: #cbd5e1; border: 1px solid #475569; }
        .excel-cell { background-color: #fff; color: #0f172a; padding: 8px; font-size: 14px; }
        .excel-header { background-color: #10b981; color: white; font-weight: bold; padding: 8px; font-size: 14px; }

        .sp-list-item { 
            background: white; 
            border-left: 4px solid #0ea5e9; 
            margin-bottom: 8px; 
            padding: 10px; 
            border-radius: 4px; 
            color: #334155; 
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            transform: translateX(20px);
            opacity: 0;
            transition: all 0.5s ease-out;
        }
        .sp-list-item.visible { transform: translateX(0); opacity: 1; }

        /* Results Panel Transitions */
        .fade-enter { opacity: 0; transform: translateY(20px); }
        .fade-enter-active { opacity: 1; transform: translateY(0); transition: opacity 500ms, transform 500ms; }
        .fade-exit { opacity: 1; }
        .fade-exit-active { opacity: 0; transition: opacity 300ms; }

        /* Locked/Unlocked States */
        .module-locked { opacity: 0.6; pointer-events: none; }
        .module-unlocked { opacity: 1; pointer-events: auto; border-color: #3b82f6; }
    </style>
</head>
<body class="h-screen flex flex-col overflow-hidden relative">

    <!-- AUTH MODAL (Added) -->
    <div id="auth-modal" class="fixed inset-0 z-[60] bg-slate-900 flex items-center justify-center p-4 transition-opacity duration-500">
        <div class="bg-slate-800 border border-slate-700 rounded-2xl p-8 max-w-md w-full shadow-2xl relative overflow-hidden">
            <!-- Decoration -->
            <div class="absolute top-0 left-0 right-0 h-1 bg-gradient-to-r from-blue-500 to-green-500"></div>
            
            <div class="text-center mb-8">
                <div class="w-16 h-16 bg-blue-900/30 rounded-full flex items-center justify-center mx-auto mb-4 border border-blue-500/30">
                    <i class="fa-brands fa-python text-3xl text-blue-400"></i>
                </div>
                <h2 id="auth-title" class="text-2xl font-bold text-white">Join the Academy</h2>
                <p id="auth-subtitle" class="text-slate-400 text-sm mt-2">Create your student profile to save progress.</p>
            </div>

            <form id="auth-form" class="space-y-4" onsubmit="handleAuth(event)">
                <div id="name-field">
                    <label class="block text-xs font-bold text-slate-400 uppercase mb-1">Student Name</label>
                    <input type="text" id="student-name" class="w-full bg-slate-900 border border-slate-700 rounded-lg p-3 text-white focus:border-blue-500 focus:outline-none transition-colors" placeholder="e.g. Ada Lovelace">
                </div>
                 <div>
                    <label class="block text-xs font-bold text-slate-400 uppercase mb-1">Email Address</label>
                    <input type="email" id="student-email" required class="w-full bg-slate-900 border border-slate-700 rounded-lg p-3 text-white focus:border-blue-500 focus:outline-none transition-colors" placeholder="student@example.com">
                </div>
                 <div>
                    <label class="block text-xs font-bold text-slate-400 uppercase mb-1">Password</label>
                    <input type="password" id="student-password" required minlength="6" class="w-full bg-slate-900 border border-slate-700 rounded-lg p-3 text-white focus:border-blue-500 focus:outline-none transition-colors" placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢">
                </div>
                
                <div id="auth-error" class="hidden bg-red-900/50 border border-red-500/50 text-red-200 text-xs p-3 rounded"></div>

                <button type="submit" id="auth-submit" class="w-full bg-blue-600 hover:bg-blue-500 text-white font-bold py-3 rounded-lg transition-all flex items-center justify-center gap-2 mt-6 disabled:opacity-50 disabled:cursor-not-allowed">
                    <span id="auth-btn-text">Start Learning</span> <i class="fa-solid fa-arrow-right"></i>
                </button>
            </form>
            
            <p class="text-center text-xs text-slate-500 mt-6">
                <span id="auth-toggle-text">Already have an account?</span> 
                <button type="button" onclick="toggleAuthMode()" class="text-blue-400 hover:text-blue-300 underline font-bold ml-1" id="auth-toggle-btn">Log in</button>
            </p>
        </div>
    </div>

    <!-- Header -->
    <header class="bg-slate-900 border-b border-slate-700 p-4 flex justify-between items-center shrink-0 z-50 relative">
        <div class="flex items-center gap-3">
            <div class="bg-blue-600 p-2 rounded-lg">
                <i class="fa-brands fa-python text-white text-xl"></i>
            </div>
            <div>
                <h1 class="font-bold text-white text-lg">Python Automation Academy</h1>
                <p class="text-xs text-slate-400">Interactive Coding Lab <span id="student-id-display" class="ml-2 text-slate-600 text-[10px]"></span></p>
            </div>
        </div>
        <div class="flex items-center gap-6">
             <button onclick="logout()" class="text-xs text-red-400 hover:text-red-300 transition-colors flex items-center gap-2 border border-red-900/30 px-3 py-1 rounded hover:bg-red-900/20">
                <i class="fa-solid fa-sign-out-alt"></i> Logout
            </button>
             <button onclick="goToDashboard()" class="text-xs text-slate-400 hover:text-white transition-colors flex items-center gap-2 border border-slate-700 px-3 py-1 rounded hover:bg-slate-800">
                <i class="fa-solid fa-house"></i> Dashboard
            </button>
            <div class="flex items-center gap-4" id="progress-container" style="opacity: 0;">
                <div class="text-xs text-slate-400">Mission Progress</div>
                <div class="w-32 h-2 bg-slate-700 rounded-full overflow-hidden">
                    <div id="progress-bar" class="h-full bg-green-500 w-0 transition-all duration-500"></div>
                </div>
            </div>
        </div>
    </header>

    <!-- Main Content -->
    <main class="flex-1 flex overflow-hidden relative bg-slate-900">
        
        <!-- DASHBOARD (Visible on Load) -->
        <div id="dashboard-container" class="absolute inset-0 z-40 bg-slate-900 flex flex-col p-8 overflow-y-auto transition-opacity duration-500">
            <div class="max-w-6xl mx-auto w-full">
                <div class="mb-10 text-center">
                    <h2 class="text-4xl font-bold text-white mb-3" id="welcome-message">Welcome, Student.</h2>
                    <p class="text-slate-400 text-lg">Select a module to begin your automation journey.</p>
                </div>

                <!-- Grid -->
                <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6 pb-10">
                    
                    <!-- Card 1: Active (The Simulator) -->
                    <div class="bg-slate-800 border-2 border-blue-500 rounded-xl p-6 relative overflow-hidden group hover:border-blue-400 transition-colors shadow-lg shadow-blue-900/20">
                        <div class="absolute top-0 right-0 bg-blue-600 text-white text-[10px] font-bold px-3 py-1 rounded-bl-lg uppercase tracking-wider">Tutor Mode</div>
                        <div class="w-14 h-14 bg-blue-900/50 rounded-xl flex items-center justify-center mb-5 text-blue-400 group-hover:scale-110 transition-transform">
                            <i class="fa-solid fa-chalkboard-user text-2xl"></i>
                        </div>
                        <h3 class="text-xl font-bold text-white mb-2">1. Excel to SharePoint</h3>
                        <p class="text-slate-400 text-sm mb-6 leading-relaxed">The Foundation. Learn to read Excel files, handle basic data cleaning, and use the API to upload lists.</p>
                        <button onclick="startWorkshop()" class="w-full bg-blue-600 hover:bg-blue-500 text-white font-bold py-3 rounded-lg transition-colors flex items-center justify-center gap-2 group-hover:shadow-lg">
                            Start Module <i class="fa-solid fa-arrow-right group-hover:translate-x-1 transition-transform"></i>
                        </button>
                    </div>

                    <!-- Card 2: Filter Logic (Initially Locked) -->
                    <div id="module-2" class="bg-slate-900 border border-slate-700 rounded-xl p-6 module-locked transition-all duration-500 relative">
                        <div class="flex justify-between items-start mb-4">
                            <div class="w-12 h-12 bg-slate-800 rounded-lg flex items-center justify-center text-slate-500" id="module-2-icon">
                                <i class="fa-solid fa-filter text-lg"></i>
                            </div>
                            <i class="fa-solid fa-lock text-slate-600" id="module-2-lock"></i>
                        </div>
                        <h3 class="text-slate-300 font-bold text-lg mb-2" id="module-2-title">2. Filter Logic</h3>
                        <p class="text-slate-500 text-xs mb-4">Upload only rows where Sales > $5000.</p>
                        <span class="text-xs font-mono text-slate-600 bg-slate-800 px-2 py-1 rounded" id="module-2-badge">Locked</span>
                        <button class="w-full bg-slate-700 text-slate-400 font-bold py-2 mt-2 rounded-lg text-sm hidden" id="module-2-btn">Start Mission</button>
                    </div>

                    <!-- Other Locked Cards -->
                    <div class="bg-slate-900 border border-slate-700 rounded-xl p-6 module-locked">
                        <div class="flex justify-between items-start mb-4">
                             <div class="w-12 h-12 bg-slate-800 rounded-lg flex items-center justify-center text-slate-500">
                                <i class="fa-solid fa-calculator text-lg"></i>
                            </div>
                            <i class="fa-solid fa-lock text-slate-600"></i>
                        </div>
                        <h3 class="text-slate-300 font-bold text-lg mb-2">3. Calculations</h3>
                        <p class="text-slate-500 text-xs mb-4">Create a new 'Tax' column before upload.</p>
                         <span class="text-xs font-mono text-slate-600 bg-slate-800 px-2 py-1 rounded">Locked</span>
                    </div>

                    <div class="bg-slate-900 border border-slate-700 rounded-xl p-6 module-locked">
                        <div class="flex justify-between items-start mb-4">
                             <div class="w-12 h-12 bg-slate-800 rounded-lg flex items-center justify-center text-slate-500">
                                <i class="fa-solid fa-folder-open text-lg"></i>
                            </div>
                            <i class="fa-solid fa-lock text-slate-600"></i>
                        </div>
                        <h3 class="text-slate-300 font-bold text-lg mb-2">4. Batch Processing</h3>
                        <p class="text-slate-500 text-xs mb-4">Loop through 50 Excel files in a folder.</p>
                         <span class="text-xs font-mono text-slate-600 bg-slate-800 px-2 py-1 rounded">Locked</span>
                    </div>

                     <div class="bg-slate-900 border border-slate-700 rounded-xl p-6 module-locked">
                        <div class="flex justify-between items-start mb-4">
                             <div class="w-12 h-12 bg-slate-800 rounded-lg flex items-center justify-center text-slate-500">
                                <i class="fa-solid fa-envelope text-lg"></i>
                            </div>
                            <i class="fa-solid fa-lock text-slate-600"></i>
                        </div>
                        <h3 class="text-slate-300 font-bold text-lg mb-2">5. Email Alerts</h3>
                        <p class="text-slate-500 text-xs mb-4">Send Outlook alerts on data errors.</p>
                         <span class="text-xs font-mono text-slate-600 bg-slate-800 px-2 py-1 rounded">Locked</span>
                    </div>

                     <div class="bg-slate-900 border border-slate-700 rounded-xl p-6 module-locked">
                        <div class="flex justify-between items-start mb-4">
                             <div class="w-12 h-12 bg-slate-800 rounded-lg flex items-center justify-center text-slate-500">
                                <i class="fa-solid fa-copy text-lg"></i>
                            </div>
                            <i class="fa-solid fa-lock text-slate-600"></i>
                        </div>
                        <h3 class="text-slate-300 font-bold text-lg mb-2">6. De-duplication</h3>
                        <p class="text-slate-500 text-xs mb-4">Check for duplicates (Upsert logic).</p>
                         <span class="text-xs font-mono text-slate-600 bg-slate-800 px-2 py-1 rounded">Locked</span>
                    </div>

                </div>
            </div>
        </div>

        <!-- WORKSHOP INTERFACE (Hidden initially) -->
        <div id="workshop-container" class="w-full h-full flex hidden opacity-0 transition-opacity duration-700">
            
            <!-- Left Panel: Guide & Code Editor -->
            <div class="w-1/3 min-w-[400px] flex flex-col border-r border-slate-700 bg-slate-900">
                
                <!-- Instructions Area -->
                <div id="instructions-panel" class="p-6 overflow-y-auto flex-1 border-b border-slate-700">
                    <div class="mb-4">
                        <span class="text-blue-400 text-xs font-bold uppercase tracking-wider">Current Mission</span>
                        <h2 id="step-title" class="text-2xl font-bold text-white mt-1">Initialize System</h2>
                    </div>
                    
                    <!-- Educational Content -->
                    <div class="mb-6">
                        <h3 class="text-slate-200 font-semibold mb-2 text-sm"><i class="fa-solid fa-book-open mr-2 text-blue-500"></i>The Concept</h3>
                        <p id="step-desc" class="text-slate-300 leading-relaxed text-sm">
                            Loading...
                        </p>
                    </div>

                    <!-- Syntax Guide -->
                    <div class="mb-6 bg-slate-800/50 rounded-lg p-4 border border-slate-700">
                        <h3 class="text-slate-200 font-semibold mb-2 text-sm"><i class="fa-solid fa-code mr-2 text-purple-400"></i>Syntax Pattern</h3>
                        <div id="step-syntax" class="font-mono text-sm text-purple-200 bg-slate-900 p-2 rounded border border-slate-700">
                            ...
                        </div>
                        <p class="text-xs text-slate-500 mt-2">Use this pattern to construct your code.</p>
                    </div>
                    
                    <!-- Task Box -->
                    <div class="bg-slate-800 rounded-lg p-4 border border-blue-900/50 shadow-lg">
                        <p class="text-xs text-blue-400 mb-2 font-bold tracking-wider">YOUR TASK</p>
                        <p id="step-task" class="text-sm text-white mb-3 font-medium">Loading...</p>
                        
                        <!-- Solution Toggle -->
                        <div class="mt-4 pt-3 border-t border-slate-700">
                            <button onclick="toggleSolution()" id="solution-btn" class="text-xs text-slate-500 hover:text-white transition-colors flex items-center gap-2">
                                <i class="fa-solid fa-key"></i> Stuck? Show Solution
                            </button>
                            <div id="solution-box" class="hidden mt-2">
                                <div class="text-xs text-slate-400 mb-1">Click below to auto-fill:</div>
                                <div id="solution-code" onclick="fillSolution()" class="text-xs text-green-400 bg-slate-900 p-2 rounded border border-slate-700 font-mono cursor-pointer hover:bg-slate-800 transition-colors">
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Code Editor Area -->
                <div class="p-4 bg-slate-950 shrink-0">
                    <div class="flex justify-between items-center mb-2">
                        <span class="text-xs text-slate-500 font-mono">main.py</span>
                        <button id="run-btn" class="bg-green-600 hover:bg-green-500 text-white text-xs px-4 py-2 rounded font-bold transition-colors flex items-center gap-2">
                            <i class="fa-solid fa-play"></i> RUN CODE
                        </button>
                    </div>
                    <div class="relative">
                        <!-- Line Numbers -->
                        <div class="absolute left-0 top-0 bottom-0 w-8 bg-slate-900 text-slate-600 text-right pr-2 pt-3 text-sm font-mono select-none border-r border-slate-800">
                            1<br>2<br>3<br>4<br>5<br>6
                        </div>
                        <!-- Input -->
                        <textarea id="code-input" class="w-full h-32 bg-slate-900 text-blue-300 p-3 pl-10 rounded border border-slate-700 focus:border-blue-500 focus:outline-none code-font text-sm resize-none" placeholder="Type your code here..."></textarea>
                    </div>
                    <div id="feedback-msg" class="h-6 mt-2 text-xs font-mono"></div>
                </div>
            </div>

            <!-- Right Panel: Visualization -->
            <div class="flex-1 bg-slate-800 p-8 flex flex-col relative overflow-hidden" id="viz-panel">
                <!-- Background Grid Pattern -->
                <div class="absolute inset-0 opacity-5" style="background-image: radial-gradient(#64748b 1px, transparent 1px); background-size: 20px 20px;"></div>

                <!-- Stage 1: The Simulation (Visible initially) -->
                <div id="simulation-stage" class="flex gap-8 h-full z-10 transition-opacity duration-500">
                    <!-- Entity 1: Excel File -->
                    <div class="w-1/2 flex flex-col transition-all duration-500" id="excel-container" style="opacity: 0.3; filter: grayscale(1);">
                        <div class="flex items-center gap-2 mb-4">
                            <i class="fa-solid fa-file-excel text-green-500 text-2xl"></i>
                            <h3 class="text-lg font-semibold text-white">Source: Excel</h3>
                        </div>
                        <div class="bg-white rounded-lg shadow-xl overflow-hidden flex-1 border-4 border-slate-700 relative">
                            <!-- Loading State -->
                            <div id="excel-loading" class="absolute inset-0 bg-slate-100 flex flex-col items-center justify-center z-20 hidden">
                                <i class="fa-solid fa-circle-notch fa-spin text-green-600 text-3xl mb-3"></i>
                                <span class="text-slate-600 font-bold text-sm">Reading File...</span>
                            </div>
                            
                            <!-- Empty State -->
                            <div id="excel-empty" class="absolute inset-0 bg-slate-200 flex flex-col items-center justify-center text-slate-400">
                                <i class="fa-solid fa-ban text-4xl mb-2"></i>
                                <span>No Data Loaded</span>
                            </div>

                            <!-- Data Table -->
                            <div id="excel-data" class="hidden h-full overflow-y-auto">
                                <div class="excel-grid">
                                    <div class="excel-header">Product</div>
                                    <div class="excel-header">Region</div>
                                    <div class="excel-header">Sales</div>
                                    
                                    <!-- Rows generated by JS -->
                                </div>
                            </div>
                        </div>
                        <div class="mt-4 bg-slate-900 p-3 rounded border border-slate-700 font-mono text-xs text-green-400 hidden" id="console-log">
                            > File loaded successfully<br>
                            > 5 rows found
                        </div>
                    </div>

                    <!-- Arrow Animation Area -->
                    <div class="w-16 flex flex-col justify-center items-center relative">
                        <div id="transfer-arrow" class="w-full h-2 bg-slate-600 rounded opacity-0 transition-all duration-500">
                            <div class="h-full bg-blue-500 w-0 animate-pulse"></div>
                        </div>
                        <i id="lock-icon" class="fa-solid fa-lock text-slate-500 text-xl absolute"></i>
                    </div>

                    <!-- Entity 2: SharePoint List -->
                    <div class="w-1/2 flex flex-col transition-all duration-500" id="sp-container" style="opacity: 0.3; filter: grayscale(1);">
                        <div class="flex items-center gap-2 mb-4">
                            <i class="fa-brands fa-microsoft text-blue-400 text-2xl"></i>
                            <h3 class="text-lg font-semibold text-white">Dest: SharePoint</h3>
                        </div>
                        <div class="bg-slate-200 rounded-lg shadow-xl flex-1 border-4 border-slate-700 p-4 overflow-y-auto relative">
                            <div class="absolute top-0 left-0 right-0 bg-blue-600 h-10 flex items-center px-4">
                                <span class="text-white text-xs font-bold uppercase">Sales List - All Items</span>
                            </div>
                            <div class="mt-12 space-y-2" id="sp-list-items">
                                <!-- List Items generated by JS -->
                                <div class="text-center text-slate-400 mt-10" id="sp-placeholder">
                                    List is empty. Waiting for connection...
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Stage 2: Final Results (Hidden initially) -->
                <div id="results-stage" class="hidden h-full z-20 flex-col overflow-y-auto">
                    <div class="flex items-center justify-between mb-8">
                        <div>
                             <h2 class="text-3xl font-bold text-white mb-1">
                                <i class="fa-solid fa-check-circle text-green-500 mr-2"></i> Mission Complete
                            </h2>
                            <p class="text-slate-400 text-sm">Module 1 Status: <span class="text-green-400 font-bold">PASSED</span></p>
                        </div>
                       
                        <div class="flex gap-4">
                             <button onclick="downloadCode()" class="bg-slate-700 hover:bg-slate-600 text-white px-6 py-2 rounded-lg font-bold transition-colors flex items-center gap-2">
                                <i class="fa-solid fa-download"></i> Save Code
                            </button>
                            <button onclick="unlockNextMission()" class="bg-blue-600 hover:bg-blue-500 text-white px-6 py-2 rounded-lg font-bold transition-colors flex items-center gap-2 animate-bounce">
                                Next Mission <i class="fa-solid fa-arrow-right"></i>
                            </button>
                        </div>
                    </div>

                    <div class="grid grid-cols-2 gap-8 h-full pb-20">
                        <!-- Column 1: Your Code -->
                        <div class="flex flex-col">
                            <h3 class="text-slate-400 text-sm font-bold uppercase mb-3">Your Python Script</h3>
                            <div class="bg-slate-950 rounded-lg border border-slate-700 p-4 flex-1 overflow-auto font-mono text-xs text-blue-300 relative group">
                                <pre id="final-code-display" class="leading-relaxed"></pre>
                            </div>
                        </div>

                        <!-- Column 2: Next Steps -->
                        <div class="flex flex-col">
                            <h3 class="text-slate-400 text-sm font-bold uppercase mb-3">Upcoming Challenges</h3>
                            <div class="bg-slate-900 rounded-lg border border-slate-700 p-6 flex-1 overflow-y-auto">
                                <p class="text-slate-400 text-sm mb-4">Excellent work. You have mastered the basics. The next mission will test your logic skills.</p>
                                <ul class="space-y-3">
                                    <li class="flex gap-3 text-sm text-white bg-blue-900/30 p-2 rounded border border-blue-500/30">
                                        <span class="bg-blue-500 text-white font-bold px-2 rounded h-6 flex items-center">NEXT</span>
                                        <span><strong>Filter Logic:</strong> Only upload rows where Sales > 5000.</span>
                                    </li>
                                    <li class="flex gap-3 text-sm text-slate-400 p-2">
                                        <span class="bg-slate-800 text-slate-500 font-bold px-2 rounded h-6 flex items-center">3</span>
                                        <span><strong>Calculations:</strong> Create a 'Tax' column before upload.</span>
                                    </li>
                                    <li class="flex gap-3 text-sm text-slate-400 p-2">
                                        <span class="bg-slate-800 text-slate-500 font-bold px-2 rounded h-6 flex items-center">4</span>
                                        <span><strong>Batch Processing:</strong> Loop through multiple files.</span>
                                    </li>
                                </ul>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </main>

    <script>
        // ==========================================
        // CONFIGURATION & ENVIRONMENT
        // ==========================================
        
        // NOTE: For a static HTML file deployed to Vercel, environment variables are NOT 
        // automatically injected into the browser. 
        // OPTION 1: Paste your keys directly below (The Anon Key is public-safe).
        // OPTION 2: Use a bundler (Vite/Webpack) which will replace 'process.env' variables.

        const getEnv = (key, fallback) => {
            if (typeof process !== 'undefined' && process.env && process.env[key]) {
                return process.env[key];
            }
            return fallback;
        };

        const SUPABASE_URL = getEnv('SUPABASE_URL', 'https://ubxvjgtjjlowbwcocwtl.supabase.co');
        const SUPABASE_KEY = getEnv('SUPABASE_KEY', 'sbp_69cdee274b6f8c9c6b3f157d4c3d1595c2c51a40');

        // ==========================================

        // State Management
        let currentStep = 0;
        const totalSteps = 7; 
        let accumulatedLines = [];
        let supabaseClient = null;
        let studentId = null;
        let studentName = "";
        let isSignUp = true; // Auth Toggle

        // Initialize Supabase
        if (SUPABASE_URL !== 'INSERT_YOUR_SUPABASE_URL' && typeof supabase !== 'undefined') {
            try {
                supabaseClient = supabase.createClient(SUPABASE_URL, SUPABASE_KEY);
                console.log('Supabase initialized');
                
                // Check Session on Load
                checkSession();

            } catch (e) {
                console.error('Supabase init failed:', e);
            }
        } else {
             // Mock session for preview if no DB configured
             if(localStorage.getItem('mock_session')) {
                document.getElementById('auth-modal').classList.add('hidden');
                studentName = "Guest User";
                document.getElementById('welcome-message').innerText = `Welcome, ${studentName}.`;
             }
        }

        async function checkSession() {
            if (!supabaseClient) return;

            const { data: { session } } = await supabaseClient.auth.getSession();
            if (session) {
                // User is logged in
                document.getElementById('auth-modal').classList.add('hidden');
                studentId = session.user.id;
                studentName = session.user.user_metadata.full_name || "Student";
                document.getElementById('student-id-display').innerText = `ID: ${studentId.substring(0,8)}...`;
                document.getElementById('welcome-message').innerText = `Welcome, ${studentName}.`;
            } else {
                // User is not logged in
                document.getElementById('auth-modal').classList.remove('hidden');
            }
        }

        function toggleAuthMode() {
            isSignUp = !isSignUp;
            const nameField = document.getElementById('name-field');
            const authTitle = document.getElementById('auth-title');
            const authSubtitle = document.getElementById('auth-subtitle');
            const btnText = document.getElementById('auth-btn-text');
            const toggleText = document.getElementById('auth-toggle-text');
            const toggleBtn = document.getElementById('auth-toggle-btn');
            
            if(isSignUp) {
                nameField.classList.remove('hidden');
                authTitle.innerText = "Join the Academy";
                authSubtitle.innerText = "Create your student profile to save progress.";
                btnText.innerText = "Start Learning";
                toggleText.innerText = "Already have an account?";
                toggleBtn.innerText = "Log in";
            } else {
                nameField.classList.add('hidden');
                authTitle.innerText = "Welcome Back";
                authSubtitle.innerText = "Log in to continue your progress.";
                btnText.innerText = "Log In";
                toggleText.innerText = "New student?";
                toggleBtn.innerText = "Create account";
            }
        }

        async function handleAuth(e) {
            e.preventDefault();
            const email = document.getElementById('student-email').value;
            const password = document.getElementById('student-password').value;
            const name = document.getElementById('student-name').value;
            const errorDiv = document.getElementById('auth-error');
            const submitBtn = document.getElementById('auth-submit');
            
            errorDiv.classList.add('hidden');
            submitBtn.disabled = true;
            submitBtn.innerHTML = '<i class="fa-solid fa-circle-notch fa-spin"></i> Processing...';

            if (!supabaseClient) {
                // Mock behavior for demo
                setTimeout(() => {
                    localStorage.setItem('mock_session', 'true');
                    document.getElementById('auth-modal').classList.add('hidden');
                    document.getElementById('welcome-message').innerText = `Welcome, ${name || 'Student'}.`;
                    alert("Mock Login Successful! (Connect Supabase to make this real)");
                }, 1000);
                return;
            }

            try {
                let error;
                let data;

                if (isSignUp) {
                    // SIGN UP
                    const res = await supabaseClient.auth.signUp({
                        email: email,
                        password: password,
                        options: {
                            data: { full_name: name }
                        }
                    });
                    error = res.error;
                    data = res.data;
                } else {
                    // LOGIN
                    const res = await supabaseClient.auth.signInWithPassword({
                        email: email,
                        password: password
                    });
                    error = res.error;
                    data = res.data;
                }

                if (error) throw error;

                // Success
                checkSession();

            } catch (err) {
                errorDiv.innerText = err.message;
                errorDiv.classList.remove('hidden');
                submitBtn.disabled = false;
                submitBtn.innerHTML = isSignUp ? 
                    '<span>Start Learning</span> <i class="fa-solid fa-arrow-right"></i>' : 
                    '<span>Log In</span> <i class="fa-solid fa-arrow-right"></i>';
            }
        }

        async function logout() {
            if(supabaseClient) {
                await supabaseClient.auth.signOut();
                checkSession();
                location.reload();
            } else {
                localStorage.removeItem('mock_session');
                location.reload();
            }
        }

        async function saveProgress(step, completed = false) {
            if (!supabaseClient || !studentId) {
                console.log(`[Mock DB] Saving progress: Step ${step}, Completed: ${completed}`);
                return;
            }

            try {
                const { error } = await supabaseClient
                    .from('student_progress')
                    .upsert({ 
                        student_id: studentId, // Uses UUID from Auth
                        module_id: 'module_1_excel_sharepoint',
                        current_step: step,
                        completed: completed,
                        updated_at: new Date().toISOString()
                    });
                
                if (error) throw error;
            } catch (err) {
                console.error('Error saving progress:', err);
            }
        }
        
        // Mock Data
        const excelData = [
            { prod: "Widget A", region: "North", sales: "5000" },
            { prod: "Widget B", region: "South", sales: "NaN" }, // Intentionally NaN
            { prod: "Widget C", region: "East", sales: "7500" },
            { prod: "Widget A", region: "West", sales: "3000" },
            { prod: "Widget D", region: "North", sales: "1200" }
        ];

        // Steps Configuration
        const steps = [
            {
                title: "1. Good Habits: Comments",
                desc: "Before we write code, we should explain it. <br><br>In Python, any line starting with a hash symbol <code>#</code> is a <strong>Comment</strong>. The computer ignores it, but it helps humans understand what the script does. Always start your scripts with a comment.",
                syntax: "# [Description of script]",
                task: "Write a comment: '# Import Sales to SharePoint'",
                solution: "# Import Sales to SharePoint",
                validate: (input) => input.trim().startsWith("#"),
                onComplete: () => {
                    logFeedback("Great habit! Comments make code readable.", "success");
                }
            },
            {
                title: "2. Import Library",
                desc: "We need <strong>pandas</strong>, the industry standard for data manipulation. We will give it a short nickname <code>pd</code> so we don't have to type 'pandas' every time we use it.",
                syntax: "import [library_name] as [alias]",
                task: "Import the pandas library and give it the alias 'pd'.",
                solution: "import pandas as pd",
                validate: (input) => input.toLowerCase().replace(/\s+/g, '').includes("importpandasaspd"),
                onComplete: () => {
                    logFeedback("Perfect! 'pd' is now your toolkit.", "success");
                    document.getElementById('excel-container').style.opacity = "0.7";
                    document.getElementById('excel-container').style.filter = "grayscale(0.5)";
                }
            },
            {
                title: "3. Read the Excel File",
                desc: "We use the <code>read_excel</code> function from our new <code>pd</code> toolkit. We need to store this result in a variable called <code>df</code> (short for DataFrame), which is like a 'programmable spreadsheet'.",
                syntax: "[variable] = pd.read_excel('[filename]')",
                task: "Create a variable named 'df' that reads 'sales_data.xlsx'.",
                solution: "df = pd.read_excel('sales_data.xlsx')",
                validate: (input) => input.includes("read_excel") && input.includes("sales_data.xlsx") && input.includes("df"),
                onComplete: () => {
                    showExcelData(true); // Show raw data (with NaN)
                    document.getElementById('excel-container').style.opacity = "1";
                    document.getElementById('excel-container').style.filter = "none";
                    document.getElementById('console-log').classList.remove('hidden');
                }
            },
            {
                title: "4. Clean the Data",
                desc: "Real-world data is messy. Look at Row 2 in the visualizer: the Sales value is <strong>NaN</strong> (Not a Number). SharePoint cannot handle NaNs. We use <code>.fillna()</code> to replace them with 0.",
                syntax: "df = df.fillna([safe_value])",
                task: "Update 'df' by filling all NaN values with 0.",
                solution: "df = df.fillna(0)",
                validate: (input) => input.includes("fillna") && input.includes("0"),
                onComplete: () => {
                    cleanExcelData(); // Update UI to remove NaN
                    logFeedback("Cleaned! NaNs replaced with 0.", "success");
                }
            },
            {
                title: "5. Connect to SharePoint",
                desc: "We create a <strong>ClientContext</strong> to open a secure tunnel to SharePoint. This holds your authentication credentials.",
                syntax: "ctx = ClientContext('[url_string]')",
                task: "Initialize a context variable 'ctx' with the URL 'https://site.url'.",
                solution: "ctx = ClientContext('https://site.url')",
                validate: (input) => input.includes("ClientContext") && input.includes("https://site.url"),
                onComplete: () => {
                    document.getElementById('sp-container').style.opacity = "1";
                    document.getElementById('sp-container').style.filter = "none";
                    document.getElementById('lock-icon').classList.replace('fa-lock', 'fa-lock-open');
                    document.getElementById('lock-icon').classList.add('text-green-500');
                    document.getElementById('lock-icon').classList.remove('text-slate-500');
                    logFeedback("Tunnel established. Connected to SharePoint.", "success");
                }
            },
            {
                title: "6. Upload Loop (Start)",
                desc: "A <strong>for loop</strong> allows us to repeat an action for every item in a collection. We use <code>.iterrows()</code> to grab data row by row.",
                syntax: "for index, row in df.iterrows():",
                task: "Write the header of the for loop.",
                solution: "for index, row in df.iterrows():",
                validate: (input) => input.includes("for") && input.includes("iterrows"),
                onComplete: () => {
                    logFeedback("Loop started. Now define the action...", "success");
                }
            },
            {
                title: "7. Send Data (Output)",
                desc: "Inside the loop, we use the <code>add_item</code> command to actually send the data to SharePoint.",
                syntax: "target_list.add_item([data_variable])",
                task: "Inside the loop, call add_item using the 'row' variable.",
                solution: "    target_list.add_item(row)",
                validate: (input) => input.includes("add_item") && input.includes("row"),
                onComplete: () => {
                    animateUpload();
                }
            }
        ];

        // DOM Elements
        const runBtn = document.getElementById('run-btn');
        const codeInput = document.getElementById('code-input');
        const feedbackMsg = document.getElementById('feedback-msg');
        
        const titleEl = document.getElementById('step-title');
        const descEl = document.getElementById('step-desc');
        const taskEl = document.getElementById('step-task');
        const syntaxEl = document.getElementById('step-syntax');
        const solutionBox = document.getElementById('solution-box');
        const solutionCode = document.getElementById('solution-code');
        const progressBar = document.getElementById('progress-bar');
        const finalCodeDisplay = document.getElementById('final-code-display');

        // Logic to Start Workshop
        function startWorkshop() {
            const dashboard = document.getElementById('dashboard-container');
            const workshop = document.getElementById('workshop-container');
            const progressContainer = document.getElementById('progress-container');

            dashboard.classList.add('fade-exit');
            dashboard.style.opacity = '0';
            dashboard.style.pointerEvents = 'none';

            setTimeout(() => {
                dashboard.style.display = 'none';
                workshop.classList.remove('hidden');
                // Force Reflow
                void workshop.offsetWidth;
                workshop.style.opacity = '1';
                progressContainer.style.opacity = '1';
                
                // Init Step 1
                updateStepUI();
                saveProgress(0, false); // Log start
            }, 500);
        }

        function goToDashboard() {
             location.reload(); 
        }
        
        function unlockNextMission() {
             const dashboard = document.getElementById('dashboard-container');
             const workshop = document.getElementById('workshop-container');
             
             // Hide Workshop
             workshop.style.opacity = '0';
             
             // Show Dashboard
             dashboard.style.display = 'flex';
             // Force Reflow
             void dashboard.offsetWidth;
             dashboard.style.opacity = '1';
             dashboard.style.pointerEvents = 'auto';
             dashboard.classList.remove('fade-exit');

             // Unlock Module 2 Logic
             const mod2 = document.getElementById('module-2');
             const mod2Icon = document.getElementById('module-2-icon');
             const mod2Lock = document.getElementById('module-2-lock');
             const mod2Title = document.getElementById('module-2-title');
             const mod2Badge = document.getElementById('module-2-badge');
             const mod2Btn = document.getElementById('module-2-btn');

             mod2.classList.remove('module-locked');
             mod2.classList.add('module-unlocked', 'bg-slate-800', 'border-blue-500', 'shadow-lg', 'shadow-blue-900/20');
             
             mod2Icon.classList.remove('bg-slate-800', 'text-slate-500');
             mod2Icon.classList.add('bg-blue-900/50', 'text-blue-400');
             
             mod2Lock.classList.remove('fa-lock');
             mod2Lock.classList.add('fa-unlock', 'text-blue-500');
             
             mod2Title.classList.remove('text-slate-300');
             mod2Title.classList.add('text-white');

             mod2Badge.innerText = "UNLOCKED";
             mod2Badge.classList.remove('text-slate-600', 'bg-slate-800');
             mod2Badge.classList.add('text-white', 'bg-green-600');
             
             mod2Btn.classList.remove('hidden');
             mod2Btn.classList.remove('bg-slate-700', 'text-slate-400');
             mod2Btn.classList.add('bg-blue-600', 'hover:bg-blue-500', 'text-white');
             mod2Btn.innerText = "Start Mission 2";

             // Hide Workshop completely after transition
             setTimeout(() => {
                 workshop.classList.add('hidden');
             }, 700);
        }

        // Event Listeners
        runBtn.addEventListener('click', runCode);
        codeInput.addEventListener('keydown', (e) => {
            if(e.key === 'Enter' && !e.shiftKey) {
                e.preventDefault();
                runCode();
            }
        });

        function updateStepUI() {
            const step = steps[currentStep];
            
            // Text Content
            titleEl.innerHTML = step.title;
            descEl.innerHTML = step.desc;
            taskEl.innerHTML = step.task;
            syntaxEl.innerHTML = step.syntax;
            solutionCode.innerText = step.solution;

            // Reset UI States
            solutionBox.classList.add('hidden');
            codeInput.value = "";
            codeInput.focus();
            
            // Progress
            progressBar.style.width = `${(currentStep / totalSteps) * 100}%`;
        }

        function toggleSolution() {
            solutionBox.classList.toggle('hidden');
        }

        function fillSolution() {
            const step = steps[currentStep];
            codeInput.value = step.solution;
            codeInput.focus();
        }

        function runCode() {
            const userCode = codeInput.value;
            const step = steps[currentStep];

            if (step.validate(userCode)) {
                logFeedback("Code executed successfully.", "success");
                
                // Accumulate Code
                accumulatedLines.push(step.solution);
                
                // Save DB
                saveProgress(currentStep + 1);

                step.onComplete();
                
                currentStep++;
                if (currentStep < totalSteps) {
                    setTimeout(() => {
                        updateStepUI();
                    }, 1500);
                } else {
                    // Finished all steps
                    saveProgress(totalSteps, true);
                }
            } else {
                logFeedback("Syntax Error. Check the Syntax Pattern above!", "error");
                codeInput.classList.add('border-red-500');
                setTimeout(() => codeInput.classList.remove('border-red-500'), 500);
            }
        }

        function logFeedback(msg, type) {
            feedbackMsg.innerText = `> ${msg}`;
            feedbackMsg.className = `h-6 mt-2 text-xs font-mono ${type === 'success' ? 'text-green-400' : 'text-red-400'}`;
        }

        function downloadCode() {
            const codeContent = accumulatedLines.join('\n');
            const blob = new Blob([codeContent], { type: 'text/x-python' });
            const url = window.URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = 'automation_script.py';
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            window.URL.revokeObjectURL(url);
        }

        // --- Visual Logic ---

        function showExcelData(hasError) {
            const loader = document.getElementById('excel-loading');
            const empty = document.getElementById('excel-empty');
            const dataDiv = document.getElementById('excel-data');
            const grid = dataDiv.querySelector('.excel-grid');

            loader.classList.remove('hidden');
            empty.classList.add('hidden');

            setTimeout(() => {
                loader.classList.add('hidden');
                dataDiv.classList.remove('hidden');

                while(grid.children.length > 3) { grid.removeChild(grid.lastChild); }

                excelData.forEach(row => {
                    const c1 = document.createElement('div'); c1.className = 'excel-cell font-mono'; c1.innerText = row.prod;
                    const c2 = document.createElement('div'); c2.className = 'excel-cell font-mono'; c2.innerText = row.region;
                    const c3 = document.createElement('div'); c3.className = `excel-cell font-mono ${row.sales === 'NaN' ? 'text-red-500 font-bold bg-red-50' : ''}`; 
                    c3.innerText = row.sales;
                    
                    grid.appendChild(c1);
                    grid.appendChild(c2);
                    grid.appendChild(c3);
                });
            }, 800);
        }

        function cleanExcelData() {
            const cells = document.querySelectorAll('.excel-cell');
            cells.forEach(cell => {
                if (cell.innerText === 'NaN') {
                    cell.innerText = '0';
                    cell.className = 'excel-cell font-mono text-green-600 font-bold bg-green-50 transition-all duration-1000';
                }
            });
        }

        function animateUpload() {
            const listContainer = document.getElementById('sp-list-items');
            document.getElementById('sp-placeholder').classList.add('hidden');
            document.getElementById('transfer-arrow').classList.remove('opacity-0');

            // Set final code
            finalCodeDisplay.innerText = accumulatedLines.join('\n');

            let delay = 0;
            excelData.forEach((row, index) => {
                delay += 800;
                setTimeout(() => {
                    const item = document.createElement('div');
                    item.className = 'sp-list-item flex justify-between items-center';
                    item.innerHTML = `
                        <div>
                            <div class="font-bold text-sm">${row.prod}</div>
                            <div class="text-xs text-slate-500">Region: ${row.region}</div>
                        </div>
                        <div class="text-blue-600 font-mono font-bold">$${row.sales === 'NaN' ? '0' : row.sales}</div>
                    `;
                    listContainer.appendChild(item);
                    void item.offsetWidth;
                    item.classList.add('visible');

                    const grid = document.querySelector('.excel-grid');
                    const startIdx = (index * 3) + 3;
                    grid.children[startIdx].style.backgroundColor = '#dcfce7';
                    grid.children[startIdx+1].style.backgroundColor = '#dcfce7';
                    grid.children[startIdx+2].style.backgroundColor = '#dcfce7';
                    
                    setTimeout(() => {
                         grid.children[startIdx].style.backgroundColor = 'white';
                        grid.children[startIdx+1].style.backgroundColor = 'white';
                        grid.children[startIdx+2].style.backgroundColor = 'white';
                    }, 400);

                }, delay);
            });

            // Transition to Final Results (No Modal)
            setTimeout(() => {
                const simStage = document.getElementById('simulation-stage');
                const resStage = document.getElementById('results-stage');
                
                simStage.classList.add('fade-exit');
                simStage.classList.add('fade-exit-active');
                
                setTimeout(() => {
                    simStage.classList.add('hidden');
                    resStage.classList.remove('hidden');
                    resStage.classList.add('fade-enter');
                    // Trigger reflow
                    void resStage.offsetWidth;
                    resStage.classList.add('fade-enter-active');
                }, 300); // Wait for exit animation
            }, delay + 1200);
        }

    </script>
</body>
</html>
